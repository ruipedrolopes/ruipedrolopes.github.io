<!DOCTYPE html>
<html>
<head>
    <title>Dencoder Unit Tests</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: sans-serif; background: #202020; color: #ececec; margin: 40px; }
        h1 { color: orange; }
        .summary { font-size: 1.2rem; margin-bottom: 20px; padding: 10px; border-radius: 4px; }
        .summary.pass { background: #1b4d1b; color: #7cfc00; }
        .summary.fail { background: #4d1b1b; color: #ff6347; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #444; vertical-align: top; }
        th { background: #333; position: sticky; top: 0; z-index: 10; }
        tr:hover { background: #2a2a2a; }
        .status-pass { color: #7cfc00; font-weight: bold; }
        .status-fail { color: #ff6347; font-weight: bold; }
        .status-crash { color: #ff00ff; font-weight: bold; background: rgba(255,0,255,0.1); padding: 2px; border-radius: 2px; }
        pre {
            background: #111;
            padding: 5px;
            border-radius: 3px;
            font-size: 0.85rem;
            margin: 0;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
        }
        .hidden { display: none; }
        tr.category-header th { background: #444; color: orange; font-size: 1.1em; text-align: left; padding-top: 20px; padding-left: 12px; }
        tr.feature-header th { background: #333; color: #ccc; padding-left: 24px; font-style: italic; font-weight: normal; }
        tr.test-row td:first-child { padding-left: 48px; color: #aaa; }
    </style>
</head>
<body>

    <h1>Dencoder Unit Tests</h1>
    <div id="summary" class="summary">Loading tests...</div>

    <table>
        <thead>
            <tr>
                <th>Test Case</th>
                <th>Input</th>
                <th>Expected</th>
                <th>Actual</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody id="testResults"></tbody>
    </table>

    <div class="hidden">
        <textarea id="value"></textarea>
        <div id="message"><span id="messageType"></span><span id="messageText"></span></div>
        <div id="historyItems"></div>
        <input type="checkbox" id="useTabs">
        <input type="checkbox" id="xmlSafe" checked>
        <input type="checkbox" id="sortDescending">
        <select id="formattingLang"></select>
        <select id="selectionMode">
            <option value="full">Full Text</option>
            <option value="selection">Selection Only</option>
            <option value="lines">Per-Line</option>
        </select>
        <input type="checkbox" id="cbCopy">
    </div>

    <script>
        window.getValueElement = () => document.getElementById('value');
        window.flashValue = () => {};
        window.fetchData = () => {};
        window.updateDetectedFormatDisplay = () => {};
        window.initHistory = () => {};
        window.formatWhitepacePadding = () => '  ';
        
        async function runSuite() {
            try {
                const response = await fetch('dencode.html');
                const html = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const scripts = doc.querySelectorAll('script');
                let scriptContent = "";
                scripts.forEach(s => scriptContent += s.textContent + "\n");
                const scriptEl = document.createElement('script');
                scriptEl.textContent = scriptContent;
                document.head.appendChild(scriptEl);
                await executeTests();
            } catch (e) {
                document.getElementById('summary').innerText = "Error loading dencode.html: " + e.message;
                document.getElementById('summary').className = "summary fail";
            }
        }

        const results = [];
        function deepCompare(a, b) {
            if (a === b) return true;
            if (typeof a !== typeof b) return false;
            if (a && b && typeof a === 'object') {
                if (Array.isArray(a)) {
                    if (a.length !== b.length) return false;
                    for (let i = 0; i < a.length; i++) if (!deepCompare(a[i], b[i])) return false;
                    return true;
                }
                const keysA = Object.keys(a), keysB = Object.keys(b);
                if (keysA.length !== keysB.length) return false;
                for (const key of keysA) if (!deepCompare(a[key], b[key])) return false;
                return true;
            }
            return false;
        }

        async function assert(category, feature, variant, input, expected, testFn) {
            let actual;
            let passed = false;
            let crashed = false;
            try {
                actual = await testFn();
                passed = (typeof expected === 'object' && expected !== null) 
                    ? deepCompare(actual, expected) 
                    : actual === expected;
            } catch (e) {
                actual = "[CRASH] " + e.message;
                passed = false;
                crashed = true;
            }
            results.push({ category, feature, variant, input, actual, expected, passed, crashed });
        }

        async function executeTests() {
            const container = document.getElementById('testResults');
            container.innerHTML = "";
            results.length = 0;

            const simpleObj = { a: 1 };
            const complexObj = {
                string: "Hello World! @#$%^&*()",
                number: -123.456,
                boolean: true,
                empty: null,
                array: [1, "two", { nested: true }, [4, 5]],
                object: { a: 1, b: { c: 2 } },
                multiline: "Line 1\nLine 2\nLine 3"
            };
            const simpleJson = JSON.stringify(simpleObj);
            const complexJson = JSON.stringify(complexObj);
            const complexEscapeInput = 'Line 1\nLine 2\t"Quote" \\Backslash\\' ;
            const complexEscapeExpected = 'Line 1\\nLine 2\\t\\\"Quote\\" \\\\Backslash\\\\';
            const cTypeExpected = '\"Line 1\\n\"\n+ \"Line 2\\t\\\"Quote\\\" \\\\Backslash\\\\\"';

            const SUITE = {
                "Modes": [
                    { feature: "Selection Mode", variant: "Partial UPPER", input: "abc def", expected: "BC D", run: async (i) => {
                        const el = getValueElement();
                        el.value = i;
                        cursorPos = { start: 1, end: 5 };
                        document.getElementById('selectionMode').value = "selection";
                        let res;
                        window.displayResult = (r) => { res = r; };
                        await transform(trs.toUpperCase);
                        return res;
                    }},
                    { feature: "Lines Mode", variant: "Per-line URL", input: "a b\nc d", expected: "a%20b\nc%20d", run: async (i) => {
                        const el = getValueElement();
                        el.value = i;
                        document.getElementById('selectionMode').value = "lines";
                        let res;
                        window.displayResult = (r) => { res = r; };
                        await transform(trs.urlencode);
                        return res;
                    }}
                ],
                "Auxiliary": [
                    { feature: "isBase64", variant: "Valid simple", input: "SGVsbG8=", expected: true, run: (i) => auxiliary.isBase64(i) },
                    { feature: "isBase64", variant: "Invalid chars", input: "Not Base64!", expected: false, run: (i) => auxiliary.isBase64(i) },
                    { feature: "isBase64", variant: "With + and /", input: "abc+", expected: true, run: (i) => auxiliary.isBase64(i) },
                    { feature: "isBase64", variant: "Invalid length", input: "abc", expected: false, run: (i) => auxiliary.isBase64(i) },
                    { feature: "isBase64", variant: "Padding check", input: "SGVsbG8=", expected: true, run: (i) => auxiliary.isBase64(i) },
                    { feature: "isHex", variant: "Valid lowercase", input: "deadbeef", expected: true, run: (i) => auxiliary.isHex(i) },
                    { feature: "isHex", variant: "Valid uppercase", input: "DEADBEEF", expected: true, run: (i) => auxiliary.isHex(i) },
                    { feature: "isHex", variant: "Invalid chars", input: "zzzz", expected: false, run: (i) => auxiliary.isHex(i) },
                    { feature: "isHex", variant: "Odd length", input: "ABC", expected: false, run: (i) => auxiliary.isHex(i) },
                    { feature: "isJson", variant: "Simple object", input: simpleJson, expected: true, run: (i) => auxiliary.isJson(i).valid },
                    { feature: "isJson", variant: "Complex object", input: complexJson, expected: true, run: (i) => auxiliary.isJson(i).valid },
                    { feature: "isJson", variant: "Invalid", input: "not json", expected: false, run: (i) => auxiliary.isJson(i) },
                    { feature: "isXml", variant: "Valid simple", input: "<root/>", expected: true, run: (i) => auxiliary.isXml(i) },
                    { feature: "isXml", variant: "Complex with attrs", input: '<root id="1">text<child/></root>', expected: true, run: (i) => auxiliary.isXml(i) },
                    { feature: "isXml", variant: "Invalid", input: "<root", expected: "object", run: (i) => typeof auxiliary.isXml(i) },
                    { feature: "isYaml", variant: "Simple indicator", input: "key: value", expected: true, run: (i) => auxiliary.isYaml(i) },
                    { feature: "isYaml", variant: "List indicator", input: "- item", expected: true, run: (i) => auxiliary.isYaml(i) },
                    { feature: "isYaml", variant: "Literal Block (|)", input: "multiline: |\n  Line 1\n  Line 2", expected: {multiline: "Line 1\nLine 2"}, run: (i) => auxiliary.yamlToObject(i) },
                    { feature: "isYaml", variant: "Folded Block ( >)", input: "multiline: >\n  Line 1\n  Line 2", expected: {multiline: "Line 1 Line 2"}, run: (i) => auxiliary.yamlToObject(i) },
                    { feature: "isYaml", variant: "No Multiline", input: "key: value\nlist:\n  - item1\n  - item2", expected: {key: "value", list: ["item1", "item2"]}, run: (i) => auxiliary.yamlToObject(i) },
                    { feature: "isYaml", variant: "Complex Valid YAML", input: [
                        'string: "Hello World! @#$%^&*()"', 'number: -123.456', 'boolean: true', 'empty: null',
                        'array:', '  - 1', '  - "two"', '  - nested: true', '  - - 4',
                        '    - 5',
                        'object:', '  a: 1', '  b:', '    c: 2', 'multiline: |',
                        '  Line 1', '  Line 2', '  Line 3'
                    ].join('\n'), expected: complexObj, run: (i) => auxiliary.yamlToObject(i) },
                    { feature: "uuidv4", variant: "Format check", input: "(generated)", expected: true, run: () => /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(auxiliary.uuidv4()) }
                ],
                "Transformers": [
                    { feature: "URL Encode", variant: "Basic", input: "hello world", expected: "hello%20world", run: (i) => trs.urlencode(i) },
                    { feature: "URL Encode", variant: "Complex chars", input: "a + b & c = d?", expected: "a%20%2B%20b%20%26%20c%20%3D%20d%3F", run: (i) => trs.urlencode(i) },
                    { feature: "URL Decode", variant: "Basic", input: "hello%20world", expected: "hello world", run: (i) => trs.urldecode(i) },
                    { feature: "URL Decode", variant: "Complex chars", input: "a%20%2B%20b%20%26%20c%20%3D%20d%3F", expected: "a + b & c = d?", run: (i) => trs.urldecode(i) },
                    { feature: "Base64 Encode", variant: "Simple", input: "Hello", expected: "SGVsbG8=", run: (i) => trs.base64encode(i) },
                    { feature: "Base64 Encode", variant: "UTF-8 Symbols", input: "Hello! \u20ac100", expected: "SGVsbG8hIOKCrDEwMA==", run: (i) => trs.base64encode(i) },
                    { feature: "Base64 Encode", variant: "UTF-8 Acute", input: "Ol\u00e1", expected: "T2zDoQ==", run: (i) => trs.base64encode(i) },
                    { feature: "Base64 Decode", variant: "UTF-8 Acute", input: "T2zDoQ==", expected: "Ol\u00e1", run: (i) => trs.base64decode(i) },
                    { feature: "Base64 Decode", variant: "UTF-8 Grave", input: "T2zDoA==", expected: "Ol\u00e0", run: (i) => trs.base64decode(i) },
                    { feature: "Hex Encode", variant: "Simple", input: "ABC", expected: "414243", run: (i) => trs.hexencode(i) },
                    { feature: "Hex Encode", variant: "Special", input: "\n\t", expected: "0a09", run: (i) => trs.hexencode(i) },
                    { feature: "Hex Decode", variant: "Simple", input: "414243", expected: "ABC", run: (i) => trs.hexdecode(i) },
                    { feature: "HTML Encode", variant: "Simple tag", input: "<div>", expected: "&lt;div&gt;", run: (i) => trs.htmlencode(i) },
                    { feature: "HTML Encode 2", variant: "Entities & Symbols", input: "\u00e1 \u00a9 \u00ae", expected: "&aacute; &#x00a9; &#x00ae;", run: (i) => trs.htmlencode2(i, {xmlSafe: () => false}) },
                    { feature: "HTML Encode 2", variant: "XML Safe", input: "\u00e1", expected: "&#x00e1;", run: (i) => trs.htmlencode2(i, {xmlSafe: () => true}) },
                    { feature: "HTML Decode", variant: "Complex", input: "&lt;div class=\"test\"&gt;&amp;&lt;/div&gt;", expected: "<div class=\"test\">&</div>", run: (i) => trs.htmldecode(i) },
                    { feature: "C-Like Escape", variant: "Simple (Truthful)", input: 'A"B', expected: 'A\\"B', run: (i) => trs.CLikeLang_StringEscape(i) },
                    { feature: "C-Like Escape", variant: "Complex (Truthful)", input: complexEscapeInput, expected: complexEscapeExpected, run: (i) => trs.CLikeLang_StringEscape(i) },
                    { feature: "C-Like Unescape", variant: "Complex (Truthful)", input: complexEscapeExpected, expected: complexEscapeInput, run: (i) => trs.CLikeLang_StringUnescape(complexEscapeExpected) },
                    { feature: "C-Like Roundtrip", variant: "Unstringify", input: complexEscapeInput, expected: complexEscapeInput, run: (i) => trs.CTypeLang_Unstringify(trs.CTypeLang_Stringify(i)) },
                    { feature: "Case Conversion", variant: "UPPER", input: "abc", expected: "ABC", run: (i) => trs.toUpperCase(i) },
                    { feature: "Case Conversion", variant: "lower", input: "ABC", expected: "abc", run: (i) => trs.toLowerCase(i) },
                    { feature: "C-Type Stringify", variant: "Simple", input: "A", expected: '"A"', run: (i) => trs.CTypeLang_Stringify(i) },
                    { feature: "C-Type Stringify", variant: "Multi-line with tabs", input: complexEscapeInput, expected: cTypeExpected, run: (i) => trs.CTypeLang_Stringify(i) },
                    { feature: "Pretty Print", variant: "JSON Simple", input: simpleJson, expected: JSON.stringify(simpleObj, null, '  '), run: (i) => trs.prettyPrint(i, {getPadding:()=>'  ', getFormatingLang:()=>'JSON'}) },
                    { feature: "Pretty Print", variant: "JSON Complex", input: complexJson, expected: JSON.stringify(complexObj, null, '  '), run: (i) => trs.prettyPrint(complexJson, {getPadding:()=>'  ', getFormatingLang:()=>'JSON'}) },
                    { feature: "Minify", variant: "JSON Complex", input: JSON.stringify(complexObj, null, 4), expected: complexJson, run: (i) => trs.minify(i, {getFormatingLang:()=>'JSON'}) },
                    { feature: "Pretty Print", variant: "XML Simple", input: "<root><child/></root>", expected: '<root>\n  <child/>\n</root>', run: (i) => trs.prettyPrint(i, {getPadding:()=>'  ', getFormatingLang:()=>'XML'}) },
                    { feature: "Pretty Print", variant: "YAML Simple", input: "a: 1\nb: 2", expected: "a: 1\nb: 2", run: (i) => trs.prettyPrint(i, {getPadding:()=>'  ', getFormatingLang:()=>'YAML'}) },
                    { feature: "Replicate", variant: "Simple", input: "A", expected: "AA", run: (i) => trs.replicate(i, {getReplicateMode:()=>"simple"}) },
                    { feature: "Replicate", variant: "Template", input: "ID: ##", expected: "ID: AID: B", run: (i) => trs.replicate(i, {getReplicateMode:()=>"template", getReplicatePlaceholder:()=>"##", getReplicateTemplateItems:()=>["A", "B"]}) },
                    { feature: "Replicate", variant: "Range", input: "## ", expected: "1 2 3 ", run: (i) => trs.replicate(i, {getReplicateMode:()=>"range", getReplicatePlaceholder:()=>"##", getReplicateRangeStart:()=>1, getReplicateRangeEnd:()=>3}) },
                    { feature: "Sort", variant: "Simple", input: "b\na", expected: "a\nb", run: (i) => trs.sort(i, {isAscending:()=>true}) },
                    { feature: "Sort JSON", variant: "Keys Asc", input: '{"b":1,"a":2}', expected: '{"a":2,"b":1}', run: (i) => trs.sortObject(i, {isAscending:()=>true, getPadding:()=>''}) },
                    { feature: "Replace", variant: "Simple All", input: "line 1", expected: "row 1", run: (i) => {
                        window.getReplaceValue = () => "line"; window.getReplaceWith = () => "row"; window.getReplaceAll = () => true;
                        window.getReplaceCaseSensitive = () => false; window.isReplaceRegex = () => false; window.getReplaceEscaped = () => false;
                        return trs.replace(i);
                    }}
                ],
                "Category 2: Variants": [
                    { feature: "Compress", variant: "Deflate", input: "hello", expected: "eJzLSM3JyQcABiwCFQ==", run: async (i) => await trs.compress(i, {compressAlgorithm:()=>"deflate"}) },
                    { feature: "Compress", variant: "Deflate Raw", input: "hello", expected: "y0jNyckHAA==", run: async (i) => await trs.compress(i, {compressAlgorithm:()=>"deflate-raw"}) },
                    { feature: "Compress", variant: "GZip", input: "hello", expected: "H4sIAAAAAAAACstIzcnJBwCGphA2BQAAAA==", run: async (i) => await trs.compress(i, {compressAlgorithm:()=>"gzip"}) },
                    { feature: "Decompress", variant: "Deflate", input: "eJzLSM3JyQcABiwCFQ==", expected: "hello", run: async (i) => await trs.decompress(i, {compressAlgorithm:()=>"deflate"}) },
                    { feature: "Decompress", variant: "Deflate Raw", input: "y0jNyckHAA==", expected: "hello", run: async (i) => await trs.decompress(i, {compressAlgorithm:()=>"deflate-raw"}) },
                    { feature: "Decompress", variant: "GZip", input: "H4sIAAAAAAAACstIzcnJBwCGphA2BQAAAA==", expected: "hello", run: async (i) => await trs.decompress(i, {compressAlgorithm:()=>"gzip"}) },
                    { feature: "Digest", variant: "SHA-256 Hex", input: "hello", expected: "2cf24dba5fb0a30e26e83b2ac5b9e29e1b161e5c1fa7425e73043362938b9824", run: async (i) => await trs.digest(i, {digestAlgorithm:()=>"SHA-256", digestOutputFormat:()=>"hex"}) },
                    { feature: "Digest", variant: "SHA-1 Base64", input: "hello", expected: "qvTGHdzF6KLavt4PO0gs2a6pQ00=", run: async (i) => await trs.digest(i, {digestAlgorithm:()=>"SHA-1", digestOutputFormat:()=>"base64"}) },
                    { feature: "Digest", variant: "SHA-384 Base64", input: "hello", expected: "WeF0h3dEjGnea4ANejO7+5/xtGPkQ1TDVTvNucZm+pASWjx5+QOXvfX2oT3oKGhP", run: async (i) => await trs.digest(i, {digestAlgorithm:()=>"SHA-384", digestOutputFormat:()=>"base64"}) },
                    { feature: "Digest", variant: "SHA-512 Hex", input: "hello", expected: "9b71d224bd62f3785d96d46ad3ea3d73319bfbc2890caadae2dff72519673ca72323c3d99ba5c11d7c7acc6e14b8c5da0c4663475c2e5c3adef46f73bcdec043", run: async (i) => await trs.digest(i, {digestAlgorithm:()=>"SHA-512", digestOutputFormat:()=>"hex"}) }
                ],
                "Category 3: Generators": [
                    { feature: "Epoch", variant: "Type check", input: "(current time)", expected: "number", run: () => typeof Number.parseInt(gens.epoch()) },
                    { feature: "ISO DateTime", variant: "Format check (Regex)", input: "(now)", expected: true, run: () => /\d{4}-\d{2}-\d{2}T/.test(gens.isoDateTime()) },
                    { feature: "Random String", variant: "Simple Lower", input: "length 5", expected: true, run: () => {
                        const rnd = gens.randomString({loadParams:()=>({length:5, lower:true, upper:false, digits:false, special:false})});
                        return rnd.length === 5 && /^[a-z]+$/.test(rnd);
                    }},
                    { feature: "Random String", variant: "UPPER and Digits", input: "length 10", expected: true, run: () => {
                        const rnd = gens.randomString({loadParams:()=>({length:10, lower:false, upper:true, digits:true, special:false})});
                        return rnd.length === 10 && /^[A-Z0-9]+$/.test(rnd);
                    }},
                    { feature: "Random String", variant: "Custom Special", input: "chars: !@", expected: true, run: () => {
                        const rnd = gens.randomString({loadParams:()=>({length:10, lower:false, upper:false, digits:false, special:true, specialChars:"!@"})});
                        return /^[!@]+$/.test(rnd);
                    }}
                ]
            };

            for (const [category, tests] of Object.entries(SUITE)) {
                for (const t of tests) {
                    await assert(category, t.feature, t.variant, t.input, t.expected, () => t.run(t.input));
                }
            }
            renderSummary();
        }

        function renderSummary() {
            const passedCount = results.filter(r => r.passed).length;
            const summary = document.getElementById('summary');
            summary.innerText = `${passedCount} / ${results.length} Tests Passed`;
            summary.className = "summary " + (passedCount === results.length ? "pass" : "fail");
            
            const container = document.getElementById('testResults');
            container.innerHTML = "";
            const grouped = {};
            results.forEach(res => {
                if (!grouped[res.category]) grouped[res.category] = {};
                if (!grouped[res.category][res.feature]) grouped[res.category][res.feature] = [];
                grouped[res.category][res.feature].push(res);
            });

            for (const category in grouped) {
                const catRow = document.createElement('tr');
                catRow.className = "category-header";
                catRow.innerHTML = `<th colspan="5">${category}</th>`;
                container.appendChild(catRow);

                for (const feature in grouped[category]) {
                    const featRow = document.createElement('tr');
                    featRow.className = "feature-header";
                    featRow.innerHTML = `<th colspan="5">${feature}</th>`;
                    container.appendChild(featRow);

                    grouped[category][feature].forEach(res => {
                        const tr = document.createElement('tr');
                        tr.className = "test-row";
                        let statusClass = res.passed ? 'status-pass' : 'status-fail';
                        if (res.crashed) statusClass = 'status-crash';
                        const displayActual = (typeof res.actual === 'object' && res.actual !== null) ? JSON.stringify(res.actual, null, 2) : String(res.actual);
                        const displayExpected = (typeof res.expected === 'object' && res.expected !== null) ? JSON.stringify(res.expected, null, 2) : String(res.expected);
                        tr.innerHTML = `<td>${res.variant}</td><td><pre>${escape(String(res.input))}</pre></td><td><pre>${escape(displayExpected)}</pre></td><td><pre>${escape(displayActual)}</pre></td><td class="${statusClass}">${res.passed ? 'PASS' : 'FAIL'}</td>`;
                        container.appendChild(tr);
                    });
                }
            }
        }

        function escape(str) {
            return str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
        }

        runSuite();
    </script>
</body>
</html>
